#!/usr/bin/env bash

set -x

# man ctags
# ctags --list-languages
# ctags-exuberant http://docs.ctags.io/en/latest/news.html#new-options

CTAGS_GEM_HOME=`rbenv exec gem environment gemdir`
CTAGS_RBENV_PREFIX=`rbenv prefix`
CTAGS_RUBY_BASENAME=`basename "${CTAGS_GEM_HOME}"`
CTAGS_RUBY_STDLIB="${CTAGS_RBENV_PREFIX}/lib/ruby/${CTAGS_RUBY_BASENAME}"

GIT_DIRECTORY="$(/usr/local/bin/git rev-parse --git-dir)"
trap 'rm -f "$GIT_DIRECTORY/$$.tags"' EXIT

git ls-files | \
/usr/local/bin/ctags --sort=foldcase --recurse=yes --tag-relative \
--languages=+ruby,-html,-javascript,-sql \
--exclude=.git \
--exclude=log \
--exclude=vendor \
--exclude=bundle \
--exclude=\*.min.js \
--exclude=jquery.\*.js \
--exclude=jquery-\*.js \
-f"$GIT_DIRECTORY/$$.tags" './' $(rbenv exec bundle list --paths) "${CTAGS_RUBY_STDLIB}"

if [[ $? -ne 0 ]]; then
  exit 1
fi

mv "$GIT_DIRECTORY/$$.tags" "$GIT_DIRECTORY/tags"

# We succeeded, reset trap and exit normally
trap - EXIT
exit 0
